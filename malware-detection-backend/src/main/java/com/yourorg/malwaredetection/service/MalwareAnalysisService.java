package com.yourorg.malwaredetection.service;

import com.yourorg.malwaredetection.model.ScanResult;
import com.yourorg.malwaredetection.repository.ScanResultRepository;
import com.yourorg.malwaredetection.websocket.AlertSender;

import java.io.BufferedReader;
import java.io.File;
import java.io.InputStreamReader;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

@Service
public class MalwareAnalysisService {

    @Autowired
    private ScanResultRepository scanResultRepository;

    @Autowired
    private AlertSender alertSender; // ‚úÖ Added for WebSocket alert

    public ScanResult analyzeFile(MultipartFile file) {
        String result = "unknown";
        try {
            // 1. Save the uploaded file temporarily
            File tempFile = File.createTempFile("upload_", "_" + file.getOriginalFilename());
            file.transferTo(tempFile);

            // 2. Run Python script using ProcessBuilder
            ProcessBuilder pb = new ProcessBuilder("python", "ml/predict.py", tempFile.getAbsolutePath());
            pb.redirectErrorStream(true);
            Process process = pb.start();

            // 3. Read output from Python script
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            result = reader.readLine();

            process.waitFor();
            tempFile.delete(); // Clean up
        } catch (Exception e) {
            e.printStackTrace();
        }

        // 4. Save and return result
        ScanResult scan = new ScanResult();
        scan.setFileName(file.getOriginalFilename());
        scan.setResult(result);
        scan.setScannedAt(System.currentTimeMillis());

        ScanResult saved = scanResultRepository.save(scan);

        // 5. üîî Send WebSocket alert if malware is found
        if ("malware".equalsIgnoreCase(result)) {
            alertSender.sendAlert("‚ö†Ô∏è Malware detected in: " + file.getOriginalFilename());
        }

        return saved;
    }
}
