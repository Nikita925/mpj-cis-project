let uploadedFile = null;

// Drag and Drop handlers
document.getElementById('upload-box').addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    document.getElementById('upload-box').style.backgroundColor = '#d6e9ff';
});

document.getElementById('upload-box').addEventListener('dragleave', () => {
    document.getElementById('upload-box').style.backgroundColor = '#ecf0f1';
});

document.getElementById('upload-box').addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    const files = e.dataTransfer.files;
    handleFileUpload(files);
});

document.getElementById('file-upload').addEventListener('change', (e) => {
    handleFileUpload(e.target.files);
});

function handleFileUpload(files) {
    if (files.length > 0) {
        uploadedFile = files[0];
        document.getElementById('scan-btn').style.display = 'inline-block';
        document.getElementById('upload-box').style.backgroundColor = '#ecf0f1';
    }
}

async function startScanning() {
    if (!uploadedFile) {
        alert("Please upload a file first.");
        return;
    }

    document.getElementById('scanning-msg').style.display = 'block';
    document.getElementById('scan-btn').style.display = 'none';

    const formData = new FormData();
    formData.append('file', uploadedFile);

    try {
        const response = await fetch('http://localhost:8080/api/scan/file', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Scan failed.');
        }

        const result = await response.json();

        document.getElementById('scanning-msg').style.display = 'none';
        document.getElementById('view-results-btn').style.display = 'inline-block';

        // Save result globally to view later
        window.latestScanResult = result;

    } catch (error) {
        console.error(error);
        alert('Failed to scan the file: ' + error.message);
        document.getElementById('scanning-msg').style.display = 'none';
    }
}

function viewScanResults() {
    if (window.latestScanResult) {
        // Display the result in a better way than alert
        const resultContainer = document.getElementById('scan-result');
        resultContainer.innerHTML = `
            <h3>Scan Result</h3>
            <p><strong>File:</strong> ${window.latestScanResult.fileName}</p>
            <p><strong>Result:</strong> ${window.latestScanResult.result}</p>
            <p><strong>Scanned At:</strong> ${new Date(window.latestScanResult.scannedAt).toLocaleString()}</p>
        `;
        resultContainer.style.display = 'block';
    } else {
        alert("No scan result found!");
    }
}

// WebSocket for Alerts
const socket = new SockJS('http://localhost:8080/malware-alerts');
const stompClient = Stomp.over(socket);

stompClient.connect({}, function(frame) {
    stompClient.subscribe('/topic/alerts', function(alertMessage) {
        const msg = alertMessage.body;
        alert(`ðŸš¨ ALERT: ${msg}`);
    });
});
